CREATE DATABASE PHUONG_PH28706
IF OBJECT_ID('CASY') IS NOT NULL
DROP TABLE CASY
CREATE TABLE CASY(
    MACS CHAR(10),
    HOTEN NVARCHAR(50),
    NGAYSINH DATE,
    QUEQUAN NVARCHAR(50),
    PRIMARY KEY (MACS)
);
IF OBJECT_ID('NHACSY') IS NOT NULL
DROP TABLE NHACSY
CREATE TABLE NHACSY(
    MANS CHAR(10),
    HOTEN NVARCHAR(50),
    NGAYSINH DATE,
    QUEQUAN NVARCHAR(50),
    DIACHI NVARCHAR(50),
    PRIMARY KEY (MANS)
);
IF OBJECT_ID('BAIHAT') IS NOT NULL
DROP TABLE BAIHAT
CREATE TABLE BAIHAT(
    MABH CHAR(10),
    TEBH NVARCHAR(50),
    NOIDUNG NVARCHAR(50),
    NAMSANGTAC DATE,
    THELOAI NVARCHAR(50),
    PRIMARY KEY (MABH)
);
IF OBJECT_ID('TRINHBAY') IS NOT NULL
DROP TABLE TRINHBAY
CREATE TABLE TRINHBAY(
    MACS CHAR(10),
    MABH CHAR(10),
    NGAYTHUAM DATE,
    PRIMARY KEY (MACS, MABH),
    FOREIGN KEY (MACS) REFERENCES CASY(MACS),
    FOREIGN KEY (MABH) REFERENCES BAIHAT(MABH)
);
IF OBJECT_ID('SANGTAC') IS NOT NULL
DROP TABLE SANGTAC
CREATE TABLE SANGTAC(
    MANS CHAR(10),
    MABH CHAR(10),
   PRIMARY KEY (MANS, MABH),
   FOREIGN KEY (MANS) REFERENCES NHACSY(MANS),
   FOREIGN KEY (MABH) REFERENCES BAIHAT(MABH)
);
INSERT INTO CASY(MACS, HOTEN, NGAYSINH, QUEQUAN) VALUES
('CS1', N'TRẦN THỊ THU PHƯƠNG', '2003/07/12', N'SẦM SƠN'),
('CS2', N'NGUYỄN KHẢ CHƯƠNG', '1993/10/20', N'THANH HOÁ'),
('CS3', N'NGUYỄN KHẢ MINH NHẬT', '2017/04/14', N'HÀ NỘI');

INSERT INTO NHACSY(MANS, HOTEN, NGAYSINH, QUEQUAN, DIACHI) VALUES
('NS1', N'PHẠM THỊ YẾN', '1995/08/12', N'BẮC GIANG', N'VIỆT TIẾN'),
('NS2', N'NGUYỄN THỊ HỒNG CÚC', '1992/03/12', N'NAM ĐỊNH', N'QUẢNG CHÂU'),
('NS3', N'DƯƠNG VĂN CƯỜNG', '1985/04/06', N'HỒ CHÍ MINH', N'CỦ CHI');

INSERT INTO BAIHAT(MABH, TEBH, NOIDUNG, NAMSANGTAC, THELOAI) VALUES
('BH1', N'THÍCH EM', N'MỘT CHÀNG TRAI THÍCH MỘT CÔ GÁI', '2017', N'TÌNH YÊU'),
('BH2', N'YÊU ANH', N'CHUYỆN TÌNH YÊU ĐÔI LỨA', '2012', N'LOVE'),
('BH3', N'HẾT THƯƠNG CẠN NHỚ', N'MISS YOU', '2009', N'SAD');

INSERT INTO TRINHBAY(MACS, MABH, NGAYTHUAM) VALUES
('CS1', 'BH2', '2011/02/12'),
('CS3', 'BH1', '2015/08/09'),
('CS2', 'BH3', '2006/08/31');

INSERT INTO SANGTAC(MANS, MABH) VALUES
('NS1', 'BH1'),
('NS1', 'BH3'),
('NS2', 'BH3');


--1
SELECT TEBH, YEAR(NAMSANGTAC) AS 'NAMST', NS.HOTEN
FROM BAIHAT AS BH
JOIN SANGTAC AS ST
ON BH.MABH=ST.MABH
JOIN NHACSY AS NS
ON ST.MANS=NS.MANS
WHERE YEAR(NAMSANGTAC) < '2013'

--2.1
SELECT *
FROM NHACSY
WHERE YEAR(GETDATE()) - YEAR(NGAYSINH) > 12

--3
SELECT TEBH, YEAR(NAMSANGTAC) AS 'NAMST', HOTEN
FROM BAIHAT AS BH
JOIN SANGTAC AS ST
ON BH.MABH=ST.MABH
JOIN NHACSY AS NS
ON ST.MANS=NS.MANS
ORDER BY HOTEN ASC

--4
SELECT * 
FROM NHACSY
WHERE YEAR(GETDATE()) - YEAR(NGAYSINH) = (SELECT TOP(1) YEAR(GETDATE()) - YEAR(NGAYSINH) FROM NHACSY ORDER BY YEAR(GETDATE()) - YEAR(NGAYSINH) DESC)

--7
SELECT TEBH, NAMSANGTAC, CS.HOTEN
FROM CASY AS CS
JOIN TRINHBAY AS TB
ON CS.MACS=TB.MACS
JOIN BAIHAT AS BH
ON TB.MABH=BH.MABH
WHERE YEAR(NAMSANGTAC) > '2015'
ORDER BY TEBH ASC