CREATE DATABASE LAB7TRENLOP
IF OBJECT_ID('MATHANG') IS NOT NULL
DROP TABLE MATHANG
CREATE TABLE MATHANG(
    MAHANG VARCHAR(50) PRIMARY KEY,
    TENHANG NVARCHAR(50),
    DONGIA INT,
);

IF OBJECT_ID('KHACHHANG') IS NOT NULL
DROP TABLE KHACHHANG
CREATE TABLE KHACHHANG(
    MAKH VARCHAR(50) PRIMARY KEY,
    TENKH NVARCHAR(50),
    NGAYSINH DATETIME,
    GIOITINH NVARCHAR(50),
    QUEQUAN NVARCHAR(50),
);

IF OBJECT_ID('HOADON') IS NOT NULL
DROP TABLE HOADON
CREATE TABLE HOADON(
    SOPHIEU VARCHAR(50) PRIMARY KEY,
    MAKH VARCHAR(50),
    NGAYLAP DATETIME,
    FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH),

);

IF OBJECT_ID('CTHOADON') IS NOT NULL
DROP TABLE CTHOADON
CREATE TABLE CTHOADON(
    SOPHIEU VARCHAR(50),
    MAHANG VARCHAR(50),
    SOLUONG INT,

    PRIMARY KEY (SOPHIEU,MAHANG),
    FOREIGN KEY (SOPHIEU) REFERENCES HOADON(SOPHIEU),
    FOREIGN KEY (MAHANG) REFERENCES MATHANG(MAHANG),

);

INSERT INTO MATHANG(MAHANG,TENHANG,DONGIA) VALUES
('M1',N'DƯỠNG MÔI OHIU','200000'),
('M2',N'TINH CHẤT OHIU','1000000'),
('M3',N'KEM DƯỠNG OHIU','550000');
SELECT * FROM MATHANG
DELETE FROM MATHANG






INSERT INTO KHACHHANG(MAKH,TENKH,NGAYSINH,GIOITINH,QUEQUAN) VALUES
('K1',N'TRẦN TRIỆU VY','2000/12/01',N'NỮ',N'HÀ NỘI'),
('K2',N'TRẦN ĐÌNH TRỌNG','2006/03/02',N'NAM',N'THÁI BÌNH'),
('K3',N'MINH HÀ','2013/03/14',N'NỮ',N'SÀI GÒN'),
('K4',N'PHẠM THỊ YẾN','2003/12/08',N'NỮ',N'BẮC GIANG');
SELECT * FROM KHACHHANG
/*CÂU 3A :Thêm một bản ghi mới vào chitiethoadon,dữ liệu phù hợp( không được nhập giá trị null).*/
INSERT INTO CTHOADON(SOPHIEU,MAHANG,SOLUONG) VALUES
('P3','M1',2);
SELECT * FROM CTHOADON
/*CÂU 3B : THAY ĐỔI QUÊ QUÁN CỦA KHÁCH HÀNG MINH HÀ THÀNH "MIỀN TÂY"*/
UPDATE KHACHHANG
SET TENKH ='MINH HÀ',QUEQUAN = N'MIỀN TÂY'
WHERE MAKH = 'K3';
/*CÂU 3C :XOÁ MẶT HÀNG CÓ TÊN "KEM DƯỠNG OHUI*/
DELETE FROM CTHOADON WHERE MAHANG = 'M3'
DELETE FROM MATHANG WHERE TENHANG = N'KEM DƯỠNG OHIU'
SELECT * FROM MATHANG


INSERT INTO HOADON(SOPHIEU,MAKH,NGAYLAP) VALUES
('P1','K1','2022/01/01'),
('P2','K1','2022/01/18'),
('P3','K3','2022/04/18');
SELECT * FROM HOADON

INSERT INTO CTHOADON(SOPHIEU,MAHANG,SOLUONG) VALUES
('P1','M1',2),
('P1','M2',3),
('P2','M2',1),
('P1','M3',2);
SELECT * FROM CTHOADON

/*CÂU 2A	Đưa ra thông tin: Makh, Tenkh, Gioitinh của những khách hàng có Họ Trần và Quequan là ‘Hà Nội’. (0.5đ). */
SELECT MAKH,TENKH,GIOITINH,QUEQUAN FROM KHACHHANG WHERE TENKH LIKE N'TRẦN%' AND QUEQUAN = N'HÀ NỘI'

/*CÂU 2B: 	Đưa ra thông tin các khách hàng > 20 tuổi. (0.5đ).  */
SELECT MAKH,NGAYSINH,TENKH,GIOITINH,QUEQUAN,YEAR(GETDATE())-YEAR(NGAYSINH) AS "TUOI" 
FROM KHACHHANG WHERE YEAR(GETDATE())-YEAR(NGAYSINH) > 20



/*CÂU 2C:	*Đưa ra thông tin danh sách các khách hàng (Makh, Tenkh, tổng tiền) có tổng thành tiền của các hóa đơn từ 1.000.000 trở lên.  TONGTIEN=SUM( SOLUONG*DONGIA)  */
SELECT KH.MAKH,TENKH ,SUM( CTHD.SOLUONG*MH.DONGIA) AS "TONGTIEN" FROM KHACHHANG
AS KH JOIN HOADON AS HD ON KH.MAKH = HD.MAKH
JOIN CTHOADON AS CTHD ON HD.SOPHIEU = CTHD.SOPHIEU
JOIN MATHANG AS MH ON CTHD.MAHANG = MH.MAHANG
GROUP BY KH.MAKH,TENKH
HAVING SUM( CTHD.SOLUONG*MH.DONGIA)  >= 1000000


/*CÂU 2D:	*Cho biết thông tin khách hàng chưa đặt đơn hàng nào. Thông tin gồm: Makh, Tenkh (1đ)*/

SELECT MAKH,TENKH FROM KHACHHANG 
WHERE  MAKH NOT IN
 ( SELECT MAKH FROM HOADON)

/*CÂU 2E:	Liệt kê thông tin: Makh, Tenkh, Mahang, Tenhang, Dongia, Soluong của khách hàng có tên khách hàng là Trần Triệu Vy . sắp xếp giảm dần theo ngay mua hàng (1đ)  */
SELECT KH.MAKH,TENKH,MH.MAHANG,TENHANG,DONGIA,SOLUONG FROM KHACHHANG AS KH 
JOIN HOADON AS HD ON KH.MAKH = HD.MAKH
JOIN CTHOADON AS CTHD ON HD.SOPHIEU = CTHD.SOPHIEU
JOIN MATHANG AS MH ON CTHD.MAHANG = MH.MAHANG
WHERE TENKH LIKE N'TRẦN TRIỆU VY' 
ORDER BY NGAYLAP DESC
/*CÂU 2F:	Đưa ra thông tin các khách đã mua hàng trong tháng 1/2022 (1đ) */
SELECT KH.MAKH,TENKH FROM KHACHHANG AS KH JOIN HOADON AS HD ON KH.MAKH = HD.MAKH
WHERE YEAR(HD.NGAYLAP) = 2022 AND MONTH(HD.NGAYLAP) = 01
GROUP BY KH.MAKH,TENKH
