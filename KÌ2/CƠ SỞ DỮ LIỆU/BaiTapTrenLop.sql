CREATE DATABASE BAITRENLOP
IF OBJECT_ID ('KHOA') IS NOT NULL
DROP TABLE KHOA
CREATE TABLE KHOA(
    MAKH VARCHAR(4) PRIMARY KEY,
    TENKH NVARCHAR(50),
    SLSV INT,


);

IF OBJECT_ID('SINHVIEN') IS NOT NULL
DROP TABLE SINHVIEN
CREATE TABLE SINHVIEN(
    MASV VARCHAR(4) PRIMARY KEY,
    HOSV NVARCHAR(40),
    TENSV NVARCHAR(30),
    PHAI NVARCHAR(10),
    NGAYSINH DATETIME,
    NOISINH NVARCHAR(30),
    MAKH VARCHAR(4),
    HOCBONG MONEY,
    DIEMTB NUMERIC(4,2)
    FOREIGN KEY (MAKH) REFERENCES KHOA(MAKH),


);

IF OBJECT_ID ('MONHOC') IS NOT NULL
DROP TABLE MONHOC
CREATE TABLE MONHOC(
    MAMH VARCHAR(4) PRIMARY KEY,
    TENMH NVARCHAR(35),
    SOTIET TINYINT,


);
ALTER TABLE MONHOC
ADD TENMH NVARCHAR(255);


IF OBJECT_ID ('KETQUA') IS NOT NULL
DROP TABLE KETQUA
CREATE TABLE KETQUA(
    MASV VARCHAR(4),
    MAMH VARCHAR(4),
    LANTHI TINYINT,
    DIEM NUMERIC(4,2),
    KETQUA VARCHAR(1),
    PRIMARY KEY(MASV,MAMH,LANTHI),
    FOREIGN KEY (MASV) REFERENCES SINHVIEN(MASV),
    FOREIGN KEY (MAMH) REFERENCES MONHOC(MAMH),

);



INSERT INTO KHOA(MAKH,TENKH) VALUES
('HTTT',N'HỆ THỐNG THÔNG TIN'),
('MANG',N'MẠNG VÀ TRUYỀN THÔNG'),
('CNPM',N'CÔNG NGHỆ PHẦN MỀN'),
('KTMT',N'KỸ THUẬT MÁY TINH'),
('KHMT',N'KHOA HỌC MÁY TÍNH');
SELECT * FROM KHOA

INSERT INTO SINHVIEN(MASV,HOSV,TENSV,PHAI,NGAYSINH,NOISINH,MAKH,HOCBONG) VALUES
('SV01',N'LÊ KIM',N'LAN',N'NỮ','1990/02/23',N'HÀ NỘI','HTTT',130000),
('SV02',N'TRẦN MINH',N'CHÁNH',N'NAM','1992/12/24',N'BÌNH ĐỊNH','MANG',150000),
('SV03',N'LÊ AN',N'TUYẾT',N'NỮ','1991/02/21',N'HẢI PHÒNG','HTTT',170000),
('SV04',N'TRẦN ANH',N'TUẤN',N'NAM','1991/12/20',N'TPHCM','MANG',80000),
('SV05',N'TRẦN THỊ',N'MAI',N'NỮ','1991/12/08',N'TPHCM','CNPM',0),
('SV06',N'LÊ THỊ THU',N'THUỶ',N'NỮ','1991/01/02',N'AN GIANG','HTTT',180000),
('SV07',N'NGUYỄN KIM',N'THƯ',N'NỮ','1990/02/02',N'HÀ NỘI','CNPM',180000),
('SV08',N'LÊ VĂN',N'LONG',N'NAM','1992/12/08',N'TPHCM','HTTT',190000);
SELECT * FROM SINHVIEN
DELETE FROM SINHVIEN

INSERT INTO MONHOC(MAMH,TENMH,SOTIET) VALUES
('CSDL',N'CƠ SỞ DỮ LIỆU',45),
('TTNT',N'TRÍ TỤE NHÂN TẠO',45),
('MMT',N'MẠNG MÁY TÍNH',45),
('DHMT',N'ĐỒ HOẠ MÁY TINH',60),
('CTDL',N'CẤU TRÚC DỮ LIỆU',60);
SELECT * FROM MONHOC

INSERT INTO KETQUA(MASV,MAMH,LANTHI,DIEM) VALUES

    ('SV01', 'CSDL', '1', '3'),
    ('SV01', 'CSDL', '2', '6'),
    ('SV01', 'TTNT', '1', '5.5'),
    ('SV01', 'TTNT', '2', '6'),
    ('SV01', 'MMT', '1', '5'),
    ('SV02', 'CSDL', '1', '4.5'),
    ('SV02', 'CSDL', '2', '7'),
    ('SV02', 'MMT', '1', '10'),
    ('SV02', 'CTDL', '1', '9'),
    ('SV03', 'CSDL', '1', '2'),
    ('SV03', 'CSDL', '2', '5'),
    ('SV03', 'MMT', '1', '2.5'),
    ('SV03', 'MMT', '2', '4'),
    ('SV04', 'CSDL', '1', '4.5'),
    ('SV04', 'CTDL', '1', '10'),
    ('SV05', 'CSDL', '1', '7'),
    ('SV05', 'MMT', '1', '2.5'),
    ('SV05', 'MMT', '2', '5'),
    ('SV06', 'TTNT', '1', '6'),
    ('SV06', 'DHMT', '1', '10');

SELECT * FROM KETQUA

---- XOA DU LIEU
DELETE FROM MONHOC

-----NEU K COS DK BAN SE K XOA DC
---NEU VUONG LOI XOA TRUNG KEY BANG KHAC , THI XOA BANG KIA TRC
WHERE TENMH = 'CSDL'
UPDATE SINHVIEN 
SET HOCBONG=HOCBONG*1.2

UPDATE MONHOC
SET SOTIET = 45
WHERE MAMH = 'CTDL';
SELECT * FROM MONHOC

UPDATE SINHVIEN
SET HOSV = 'LE KIM', TENSV = 'LÂN', PHAI ='NAM'
WHERE MASV = 'SV01';
SELECT * FROM SINHVIEN


UPDATE SINHVIEN 
SET HOCBONG=HOCBONG*1.2
WHERE MAKH = 'MANG';


UPDATE KETQUA
SET KETQUA = 'D'
WHERE DIEM>0 AND DIEM<5;

UPDATE KETQUA
SET KETQUA = 'K'
WHERE DIEM>=5 AND DIEM<=10;


UPDATE SINHVIEN
SET DIEMTB = ( SELECT AVG(DIEM) FROM KETQUA WHERE MASV='SV01' AND LANTHI=1 )
WHERE MASV='SV01';

UPDATE SINHVIEN
SET DIEMTB = ( SELECT AVG(DIEM) FROM KETQUA WHERE MASV=SINHVIEN.MASV AND LANTHI=1 );

UPDATE SINHVIEN
SET DIEMTB = ( SELECT AVG(DIEM) FROM KETQUA WHERE MASV=SINHVIEN.MASV AND LANTHI = 1 );

DELETE FROM SINHVIEN WHERE HOCBONG = 0;
  

SELECT * FROM SINHVIEN----NGHIA LA IN RA HET CAC THONG TIN

SELECT MASV,HOSV,TENSV FROM SINHVIEN---KHONG PHAN BIET VIET HOA VIET THUONG 


SELECT * FROM SINHVIEN ORDER BY MASV--- K VIET THI AUTO LA ASC(TANG)
---ORDER BY LA SAP XEP, DESC LAF GIAM, ASC LA TANG
SELECT * FROM SINHVIEN ORDER BY MASV DESC
SELECT * FROM SINHVIEN ORDER BY MASV ASC

SELECT * FROM SINHVIEN ORDER BY TENSV ASC

---DISTINCT LOC DU LIEU TRUNG NHAU
SELECT DISTINCT NOISINH FROM SINHVIEN


----WHERE DIEU KIEN
SELECT * FROM SINHVIEN WHERE NOISINH=N'HÀ NỘI'
SELECT * FROM SINHVIEN WHERE PHAI = N'NỮ'



--------------------TRUY VẤN----------------------
---11
SELECT MASV,HOSV,TENSV,HOCBONG FROM  SINHVIEN ORDER BY MASV ASC

---12
SELECT * FROM SINHVIEN ORDER BY PHAI,TENSV ASC

---13
SELECT DISTINCT NOISINH FROM SINHVIEN

--14
SELECT MAMH,TENMH,SOTIET FROM MONHOC WHERE TENMH LIKE 'T%'

----15
SELECT  HOSV,TENSV,HOCBONG  FROM SINHVIEN WHERE HOCBONG < 160000 AND NOISINH=N'TPHCM'

---16
SELECT  MASV,MAKH FROM SINHVIEN WHERE MAKH='HTTT' OR MAKH='CNPM'

---17
SELECT MASV,NGAYSINH,NOISINH,HOCBONG FROM SINHVIEN WHERE NGAYSINH > '01/01/1991' AND NGAYSINH < '05/06/1992 ' 




--------------------------TRUY VẤN DÙNG HÀM------------------------
----LIKE--
SELECT TENSV FROM SINHVIEN WHERE TENSV LIKE '-A%'
SELECT TENSV FROM SINHVIEN WHERE TENSV LIKE 'TH--%'
SELECT TENSV FROM SINHVIEN WHERE TENSV LIKE 'L%G%'
---AND OR NOT
---18
SELECT  KH.MAKH TENKH,TENSV FROM KHOA AS KH JOIN SINHVIEN AS SV ON KH.MAKH = SV.MAKH
GROUP BY KH.MAKH,TENSV HAVING KH.MAKH IN(SELECT MAKH FROM KHOA) OR KH.MAKH NOT IN(SELECT MAKH FROM KHOA)
-----19
 SELECT * FROM SINHVIEN WHERE NOISINH='TPHCM' AND HOCBONG>0 --AND LA DIEU KIEN VA
 SELECT * FROM SINHVIEN WHERE PHAI='NAM' OR HOCBONG>0 -- OR 1 TRONG 2 DIEU KIEN
 SELECT * FROM SINHVIEN WHERE NOT  PHAI != 'NAM'-- NOT KKHONG THUOC KHOANG
 -----YEAR MONTH DAY,GETDATE -- GETDATE LAY HIEN TAI,YEAR LA LAY NAM,MONTH LAY THANH, DAY LAY NGAY
--------20
 SELECT * ,YEAR(GETDATE())-YEAR(NGAYSINH) AS TUOI FROM SINHVIEN WHERE YEAR (NGAYSINH) >= 1991
 ----BETWEEN LA GIUA
 SELECT * FROM SINHVIEN WHERE NGAYSINH BETWEEN '01/01/1991' AND '05/06/1992'
 ---MIN,MAX COUNT SUM AVG
 SELECT MIN (MASV) AS  MINHOCBONG FROM SINHVIEN
 SELECT MAX(YEAR(NGAYSINH)) MAXNAMSINH FROM SINHVIEN
 --AVRG TRUNG BINH
 SELECT AVG(HOCBONG) FROM SINHVIEN
 ---COUNT DIEM
 SELECT COUNT(MASV) FROM SINHVIEN WHERE PHAI=N'NU'
 ----SUM 
 SELECT SUM(HOCBONG) FROM SINHVIEN







 --------------------TRUY VẤN DÙNG HÀM TÍNH TOÁN : MAX,MIN, COUNT,SUM,AVG------------



 ----23
 SELECT COUNT(MASV) FROM SINHVIEN

 -----24
 SELECT COUNT(PHAI) FROM SINHVIEN WHERE PHAI = N'NU'


 ------25
 SELECT SUM(HOCBONG) FROM SINHVIEN
 -----26
 SELECT COUNT(DISTINCT NOISINH) FROM SINHVIEN


 --27
 SELECT MAKH , COUNT(MASV) AS SLSV FROM SINHVIEN GROUP BY MAKH

-----28
SELECT MAMH, COUNT(DISTINCT MASV) AS SLSV FROM KETQUA GROUP BY MAMH

-----29
SELECT MASV, COUNT(DISTINCT MAMH) AS SLMH FROM KETQUA GROUP BY MASV

--------30
SELECT COUNT(DISTINCT NOISINH) from SINHVIEN

--31--
SELECT MAKH, MAX(HOCBONG) from SINHVIEN GROUP BY MAKH
--32--
SELECT MAKH ,COUNT(MASV) as TONGSONAM from SINHVIEN
WHERE PHAI = N'Nam'
GROUP BY MAKH

SELECT MAKH ,COUNT(MASV) as TONGSONU from SINHVIEN 
WHERE PHAI = N'Nữ'
GROUP BY MAKH
------

--33--
SELECT YEAR(GETDATE())-YEAR(NGAYSINH) AS DOTUOI, COUNT(MASV) AS SLSV FROM SINHVIEN
GROUP BY YEAR(GETDATE())-YEAR(NGAYSINH)
--34--
SELECT NOISINH, COUNT(MASV) AS SOSV FROM SINHVIEN
GROUP BY NOISINH
HAVING COUNT(NOISINH) >=2
--35--
SELECT MAMH, COUNT(DISTINCT MASV) SOSVDUTHI FROM KETQUA
GROUP BY MAMH
HAVING COUNT(DISTINCT MASV) >3
--36--
SELECT MASV, MAMH, COUNT(LANTHI) SOLANTHILAI from KETQUA
GROUP BY MASV, MAMH
HAVING COUNT(LANTHI) >=2
--37--
SELECT MAKH FROM SINHVIEN 
GROUP BY MAKH
HAVING COUNT(MASV) =2 AND SUM(HOCBONG) BETWEEN 200000 AND 300000

--38--
SELECT MAMH, COUNT(MASV) SODVDAT FROM KETQUA
WHERE LANTHI=1 and DIEM>=5
GROUP BY MAMH

SELECT MAMH, COUNT(MASV) SODVKHONGDAT FROM KETQUA
WHERE LANTHI=1 and DIEM<5
GROUP BY MAMH




-----------GROUP BY---------sắp xếp 
SELECT MAKH,COUNT (MAKH) SLSV FROM SINHVIEN
GROUP BY MAKH

-------------------JOIN---------KẾT HỢP THÔNG TIN NHIỀU BẢNG
--JOIN LẤY PHẦN CHUNG
SELECT * FROM SINHVIEN JOIN KETQUA ON SINHVIEN.MASV = KETQUA.MASV

-----FULL JOIN---LẤY TẤT CẢ
SELECT * FROM SINHVIEN FULL JOIN KETQUA ON SINHVIEN.MASV = KETQUA.MASV

-----RIGHT JOIN
SELECT * FROM SINHVIEN RIGHT JOIN KETQUA ON SINHVIEN.MASV = KETQUA.MASV

-----LEFT JOIN
SELECT * FROM SINHVIEN LEFT JOIN KETQUA ON SINHVIEN.MASV = KETQUA.MASV







---3---
UPDATE MONHOC
SET SOTIET = 45
WHERE MAMH = 'CTDL';
---4---
UPDATE sinhVien
SET HOSV = 'Lê Kim', TENSV = 'Lân', PHAI = 'Nam'
WHERE MASV = 'SV01';
---5---
UPDATE sinhVien
SET HOCBONG = HOCBONG*1.2
WHERE MAKH = 'MANG';
select * from sinhVien
---6---
UPDATE KETQUA
SET KETQUA = 'D'
WHERE DIEM>0 AND DIEM<5;

UPDATE KETQUA
SET KETQUA = 'K'
WHERE DIEM>=5 AND DIEM<=10;

---7---
UPDATE sinhVien
SET DIEMTB = ( SELECT AVG(DIEM) FROM KETQUA WHERE MASV='SV01' AND LANTHI=1 )
WHERE MASV='SV01';
select * from sinhvien
---8---
UPDATE sinhVien
SET DIEMTB = ( SELECT AVG(DIEM) FROM KETQUA WHERE MASV=SINHVIEN.MASV AND LANTHI=1 );
---9---
UPDATE sinhVien
SET DIEMTB = ( SELECT AVG(DIEM) FROM KETQUA WHERE MASV=SINHVIEN.MASV);


-- * là in ra hết các thông tin
select * from sinhVien

select MASV,HOSV,TENSV from sinhVien

-- order by là sắp xếp:  desc là giảm dần, asc là tăng dần, k để auto là asc
select * from sinhVien order by PHAI,MASV desc
select * from sinhVien order by PHAI desc, MASV asc
-- distinct lọc những dữ liệu trùng nhau
select distinct NOISINH from sinhVien
-- where điều kiện
select * from sinhVien where NOISINH=N'Hà Nội'

---11---
select MASV, HOSV, TENSV, HOCBONG from sinhvien order by MASV
---12---
select * from sinhVien order by PHAI, TENSV
---13---
select distinct NOISINH from sinhVien
---14---
select * from MONHOC
 where TENMH like 'T%' --bắt đầu là T
 select * from MONHOC
 where TENMH like '%u'
 --%T là kết thúc là T
 --%T% 
 -- _a% là chữ thứ 2 là a
 -- a_% là bắt đầu = a, có ít nhất 2 kí tự
 -- t%a là bắt đầu = t, kết thúc = a
---15---
select HOSV, TENSV, HOCBONG from sinhVien where HOCBONG<160000 and NOISINH ='TpHCM'
---16---
select MASV, MAKH from sinhVien where MAKH ='HTTT' OR MAKH='CNPM'
---17---
select MASV, NGSINH, NOISINH, HOCBONG from sinhVien where NGSINH>='01/01/1991' and NGSINH<='05/06/1992'
---18---
select KHOA.MAKH, KHOA.TENKH, sinhVien.HOSV, sinhVien.TENSV from KHOA, sinhVien 
where KHOA.MAKH = sinhVien.MAKH
order by KHOA.MAKH

select * from sinhVien where not PHAI='Nam' -- not: không thuộc khoảng
--year month date, getdate
select *,year(GETDATE())-year(NGSINH) as tuoi from sinhVien where year(NGSINH)>1991
---------thêm cột tuổi  (có thể thêm 'as' hoặc k)
--getdate lấy ngày hiện tại

--between (có lấy giá trị bằng)
select * from sinhVien where NGSINH between '01/01/1991' and '05/06/1992'

-- min, max, count, sum, avg
select min(hocbong) as minHocBong from sinhVien 
select max(YEAR(ngsinh)) maxNamSinh from sinhVien
select avg(hocbong) from sinhVien
select count(masv) from sinhVien where PHAI=N'Nữ'
select sum(hocbong) from sinhVien


--19--
select MASV, HOSV, TENSV, NGSINH from sinhVien where MONTH(NGSINH)=12 and NOISINH='TpHCM'
--20--
select HOSV, TENSV, YEAR(getdate())-YEAR(NGSINH) as tuoi, HOCBONG from sinhVien 
where YEAR(getdate())-YEAR(NGSINH) >20
--21--
select MASV, PHAI, MAKH,
CASE
    WHEN HOCBONG>150000 THEN N'Học bổng cao'
ELSE N'Mức trung bình'
END as mucHocBong
from sinhVien
--22--
select sinhVien.HOSV, sinhVien.TENSV, KETQUA.MAMH, KETQUA.LANTHI, KETQUA.DIEM, KETQUA.KETQUA, 
case when DIEM<5 then N'Không đạt' else N'Đạt' end
from KETQUA join sinhVien on sinhVien.MASV=KETQUA.MASV

--23--
select count(MASV) from sinhVien
--24--
select count(MASV) from sinhVien where PHAI=N'Nữ'
--25--
select sum(hocbong) from sinhVien
--26--
select COUNT(distinct NOISINH) from sinhVien
--27--
select MAKH, COUNT(MASV) as soLuongSV from sinhVien group by MAKH
--28--
select MAMH, COUNT(distinct MASV) as soLuongSV from KETQUA group by MAMH
--29--
select MASV, COUNT(distinct MAMH) as soLuongMonHoc from KETQUA group by MASV
--30--
select MAKH, sum(HOCBONG) as tongHocBong from sinhVien group by MAKH
--31--
select MAKH, max(HOCBONG) from sinhVien group by MAKH
--32--
select MAKH ,COUNT(MASV) as tongSoNam from sinhVien 
where PHAI = N'Nam'
group by MAKH

select MAKH ,COUNT(MASV) as tongSoNu from sinhVien 
where PHAI = N'Nữ'
group by MAKH
--33--
select YEAR(getdate())-YEAR(NGSINH) as doTuoi, COUNT(MASV) as soLuongSV from sinhVien
group by YEAR(getdate())-YEAR(NGSINH)
--34--
select NOISINH, COUNT(MASV) as soSV from sinhVien
group by NOISINH
having COUNT(NOISINH) >=2
--35--
select MAMH, COUNT(distinct MASV) soSVDuThi from KETQUA
group by MAMH
having COUNT(distinct MASV) >3
--36--
select MASV, MAMH, COUNT(LANTHI) soLanThiLai from KETQUA
group by MASV, MAMH
having COUNT(LANTHI) >=2
--37--
select MAKH from sinhVien 
group by MAKH
having count(MASV) =2 and sum(HOCBONG) between 200000 and 300000

--38--
select MAMH, COUNT(MASV) soSVDat from KETQUA
where LANTHI=1 and DIEM>=5
group by MAMH

select MAMH, COUNT(MASV) soSVKhongDat from KETQUA
where LANTHI=1 and DIEM<5
group by MAMH
